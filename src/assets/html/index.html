<html>
    <head>
        <!-- Add any necessary CSS or additional libraries here -->
    </head>
    <body>
        <p>TESTES</p>
        <canvas id="oscilloscope"></canvas>
        <script>
            let isMuted = false;
            let visualizerGain;
            var analyser;

            function setupVisualfluff(x) {
                analyser = audioContext.createAnalyser();
                masterGain.connect(analyser);

                const waveform = new Float32Array(analyser.frequencyBinCount);
                analyser.getFloatTimeDomainData(waveform);

                function updateWaveForm() {
                    requestAnimationFrame(updateWaveForm);
                    analyser.getFloatTimeDomainData(waveform);
                }

                function drawOscilloscope() {
                    requestAnimationFrame(drawOscilloscope);

                    const scopeCanvas = document.getElementById("oscilloscope");
                    const scopeContext = scopeCanvas.getContext("2d", { alpha: true });

                    scopeCanvas.width = window.innerWidth;
                    scopeCanvas.height = 75;

                    scopeContext.clearRect(0, 0, scopeCanvas.width, scopeCanvas.height);
                    scopeContext.beginPath();

                    for (let i = 0; i < waveform.length; i++) {
                        const x = i * (scopeCanvas.width / 1000);
                        const y = (0.5 + waveform[i] / 2) * scopeCanvas.height;

                        if (i == 0) {
                            scopeContext.moveTo(x, y);
                        } else {
                            scopeContext.lineTo(x, y);
                        }
                    }

                    scopeContext.strokeStyle = "#723eb2";
                    scopeContext.lineWidth = 3;
                    scopeContext.stroke();
                }

                if (x == "hide") {
                    const scopeCanvas = document.getElementById("oscilloscope");
                    scopeCanvas.width = 0;
                    scopeCanvas.height = 0;
                    return;
                } else {
                    drawOscilloscope();
                    updateWaveForm();
                    window.hasOsci = true;
                }
            }

            function toggleMute() {
                const gainValue = isMuted ? 1 : 0;
                masterGain.gain.value = gainValue;
                isMuted = !isMuted;
            }

            function startplayer() {
                window.audioContext = new (window.AudioContext || window.webkitAudioContext);
                document.addEventListener('touchend', ()=>window.audioContext.resume());
                window.audioContext.resume();
                window.masterGain = audioContext.createGain();
                window.masterGain.connect(audioContext.destination);
                if (!window.hasOsci) {
                    setupVisualfluff();
                } else {
                    console.log("wario land 4, play it.");
                }
                const url = "https://cast.animu.com.br:9079/stream";
                song = new Audio(url);
                var songSource = audioContext.createMediaElementSource(song);
                songSource.muted = true;
                song.crossOrigin = "anonymous";
                var gainNode = audioContext.createGain();
                songSource.connect(masterGain);
                song.preload = "none";
                var gainfrac = 0;
                if (window.masterGain) window.masterGain.gain.value = 1;
                window.song_result = song.play();
                window.songPlaying = true;

                  // Connect the visualizer gain at the end of the startplayer function
                visualizerGain = audioContext.createGain();
                analyser.connect(visualizerGain);
                visualizerGain.connect(audioContext.destination);
            }

            startplayer();
        </script>
        <button id="teste" onclick="startplayer()">Play</button>
        <button onclick="toggleMute()">Mute/Unmute</button>
    </body>
</html>

